<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="d3cloud.js"></script>
<link href="https://fonts.googleapis.com/css?family=Lobster|Raleway" rel="stylesheet">
<body>
<strong>Género</strong> </br>
<input type="checkbox" id="checkFemale" checked> Hembra
<input type="checkbox" id="checkMale" checked> Varón
</br><strong>Ubicación</strong></br>
<input type="checkbox" id="checkAntioquia" > Antioquia
<input type="checkbox" id="checkBogota" > Bogota
<input type="checkbox" id="checkCafetero" > Cafetero
<input type="checkbox" id="checkCaribe" > Caribe
<input type="checkbox" id="checkCentro" > Centro
<input type="checkbox" id="checkOriento" > Oriento
<input type="checkbox" id="checkOtres" > Otres
<input type="checkbox" id="checkPacifica" > Pacifica
<input type="checkbox" id="checkOtro" > Otro
</br>

<script>
  var margin = {top: 20, right: 20, bottom: 40, left: 20},
    width = 600 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

  var hashObjs = [];
  var hashM = [];
  var hashF = [];
  var antioquiaObjs = [];  // ALL Antioquia[];
  var antioquiaM = [];    // All Antioqu[];[];e
  var antioquiaF = [];     // All Antioq[];[];male
  var bogotaObjs = [];  // All [];[];
  var bogotaM = [];    // All B[];ta Male
  var bogotaF = [];     // All Bogota Female
  var cafeteroObjs = [];  // All Bogota
  var cafeteroM = [];     // All Bogota Male
  var cafeteroF = [];     // All Bogota Female
  var caribeObjs = [];  // ALL Caribe
  var caribeM = [];     // All Caribe Male
  var caribeF = [];     // All Caribe Female
  var centroObjs = [];  // ALL Caribe
  var centroM = [];     // All Caribe Male
  var centroF = [];     // All Caribe Female
  var orientoObjs = [];  // ALL Caribe
  var orientoM = [];     // All Caribe Male
  var orientoF = [];     // All Caribe Female
  var otresObjs = [];  // ALL Caribe
  var otresM = [];     // All Caribe Male
  var otresF = [];     // All Caribe Female
  var pacificaObjs = [];  // ALL Caribe
  var pacificaM = [];     // All Caribe Male
  var pacificaF = [];     // All Caribe Female
  var otherObjs = [];  // ALL Caribe
  var otherM = [];     // All Caribe Male
  var otherF = [];     // All Caribe Female

  var tweet_hashes = "";
  var antioquia_hashes = "";
  var bogota_hashes = "";
  var cafetero_hashes = "";
  var caribe_hashes = "";
  var centro_hashes = "";
  var oriento_hashes = "";
  var otres_hashes = "";
  var pacifica_hashes = "";
  var other_hashes = "";

  var tweet_hashes_m = "";
  var antioquia_hashes_m = "";
  var bogota_hashes_m = "";
  var cafetero_hashes_m = "";
  var caribe_hashes_m = "";
  var centro_hashes_m = "";
  var oriento_hashes_m = "";
  var otres_hashes_m = "";
  var pacifica_hashes_m = "";
  var other_hashes_m = "";

  var tweet_hashes_f = "";
  var antioquia_hashes_f = "";
  var bogota_hashes_f = "";
  var cafetero_hashes_f = "";
  var caribe_hashes_f = "";
  var centro_hashes_f = "";
  var oriento_hashes_f = "";
  var otres_hashes_f = "";
  var pacifica_hashes_f = "";
  var other_hashes_f = "";

  d3.csv("twitter.csv", function(error, data) {

      data.forEach(function(d){
        var h = d.tweet_hashtag;
        h = h.replace(/,/g, " ");
        if(d.user_location == "Bogota"){
          if(d.user_gender == "Male"){
            bogota_hashes_m += h;
            bogota_hashes_m += " ";
          } else {
            bogota_hashes_f += h;
            bogota_hashes_f += " ";
          }
          bogota_hashes += h;
          bogota_hashes += " ";
        }
        else if(d.user_location == "Cafetero"){
          if(d.user_gender == "Male"){
            cafetero_hashes_m += h;
            cafetero_hashes_m += " ";
          } else {
            cafetero_hashes_f += h;
            cafetero_hashes_f += " ";
          }
          cafetero_hashes += h;
          cafetero_hashes += " ";      
        }
        else if(d.user_location == "Caribe"){
          if(d.user_gender == "Male"){
            caribe_hashes_m += h;
            caribe_hashes_m += " ";
          } else {
            caribe_hashes_f += h;
            caribe_hashes_f += " ";
          }
          caribe_hashes += h;
          caribe_hashes += " ";      
        }
        else if(d.user_location == "Centro"){
          if(d.user_gender == "Male"){
            centro_hashes_m += h;
            centro_hashes_m += " ";
          } else {
            centro_hashes_f += h;
            centro_hashes_f += " ";
          }
          centro_hashes += h;
          centro_hashes += " ";      
        }
       else if(d.user_location == "Oriento"){
          if(d.user_gender == "Male"){
            oriento_hashes_m += h;
            oriento_hashes_m += " ";
          } else {
            oriento_hashes_f += h;
            oriento_hashes_f += " ";
          }
          oriento_hashes += h;
          oriento_hashes += " ";      
        }
        else if(d.user_location == "Otres"){
          if(d.user_gender == "Male"){
            otres_hashes_m += h;
            otres_hashes_m += " ";
          } else {
            otres_hashes_f += h;
            otres_hashes_f += " ";
          }
          otres_hashes += h;
          otres_hashes += " ";      
        }
        else if(d.user_location == "Pacifica"){
          if(d.user_gender == "Male"){
            pacifica_hashes_m += h;
            pacifica_hashes_m += " ";
          } else {
            pacifica_hashes_f += h;
            pacifica_hashes_f += " ";
          }
          pacifica_hashes += h;
          pacifica_hashes += " ";      
        }
        else if(d.user_location == "Antioquia"){
          if(d.user_gender == "Male"){
            antioquia_hashes_m += h;
            antioquia_hashes_m += " ";
          } else {
            antioquia_hashes_f += h;
            antioquia_hashes_f += " ";
          }
          antioquia_hashes += h;
          antioquia_hashes += " ";      
        }
        else {
          if(d.user_gender == "Male"){
            other_hashes_m += h;
            other_hashes_m += " ";
          } else {
            other_hashes_f += h;
            other_hashes_f += " ";
          }
          other_hashes += h;
          other_hashes += " ";      
        }      
        if(d.user_gender == "Male"){
            tweet_hashes_m += h;
            tweet_hashes_m += " ";
          } else {
            tweet_hashes_f += h;
            tweet_hashes_f += " ";
          }
        tweet_hashes += h;
        tweet_hashes += " ";
      });

        mydataisready();
        mywc = wordCloud('body', hashObjs);
    });

d3.select("#checkFemale").on("change", updateData);
d3.select("#checkMale").on("change", updateData);
d3.select("#checkAntioquia").on("change", updateData);
d3.select("#checkBogota").on("change", updateData);
d3.select("#checkCafetero").on("change", updateData);
d3.select("#checkCaribe").on("change", updateData);
d3.select("#checkCentro").on("change", updateData);
d3.select("#checkOriento").on("change", updateData);
d3.select("#checkOtres").on("change", updateData);
d3.select("#checkPacifica").on("change", updateData);
d3.select("#checkOtro").on("change", updateData);

function mydataisready(){
  processFilters(other_hashes, otherObjs);
  processFilters(other_hashes_f, otherF);
  processFilters(other_hashes_m, otherM);

  processFilters(antioquia_hashes, antioquiaObjs);
  processFilters(antioquia_hashes_f, antioquiaF);
  processFilters(antioquia_hashes_m, antioquiaM);

  processFilters(bogota_hashes, bogotaObjs);
  processFilters(bogota_hashes_f, bogotaF);
  processFilters(bogota_hashes_m, bogotaM);

  processFilters(caribe_hashes, caribeObjs);
  processFilters(caribe_hashes_f, caribeF);
  processFilters(caribe_hashes_m, caribeM);

  processFilters(cafetero_hashes, cafeteroObjs);
  processFilters(cafetero_hashes_f, cafeteroF);
  processFilters(cafetero_hashes_m, cafeteroM);

  processFilters(centro_hashes, centroObjs);
  processFilters(centro_hashes_f, centroF);
  processFilters(centro_hashes_m, centroM);

  processFilters(oriento_hashes, centroObjs);
  processFilters(oriento_hashes_f, centroF);
  processFilters(oriento_hashes_m, centroM);

  processFilters(otres_hashes, otresObjs);
  processFilters(otres_hashes_f, otresF);
  processFilters(otres_hashes_m, otresM);

  processFilters(pacifica_hashes, pacificaObjs);
  processFilters(pacifica_hashes_f, pacificaF);
  processFilters(pacifica_hashes_m, pacificaM);

  processFilters(tweet_hashes, hashObjs);
  processFilters(tweet_hashes_f, hashF);
  processFilters(tweet_hashes_m, hashM);

}

function processFilters(data, newarray){
  var split_array = data.split(" ");
  split_array.forEach(function(d){
    var hashObj = {}
    hashObj.hashtag = d;
    newarray.push(hashObj);
  });  
}

function wordCloud(selector, data) {
  var wordCount = d3.nest()
                    .key(function(d) {return d.hashtag;})
                    .rollup(function(v) {return v.length;})
                    .entries(data);
    wordCount.sort(function(a,b){
    return b.values-a.values;
  });
  var tags = [];
  wordCount.forEach(function(d){
    tags.push([d.key, parseInt(d.values)]);
  });
  var max = wordCount[0].values + 1;
  var maxfontSize = 0;
  tags = tags.slice(0,100); // choose top 250 words
  var color = "#5e6472";
  var fontSize = d3.scale.pow().exponent(5).domain([0,1]).range([10,80]);
  var layout = d3.layout.cloud()
      .timeInterval(10)
      .size([width, height])
      .words(tags)
      .rotate(function(d) { return 0; })
      .font('Raleway')
      .fontSize(function(d,i) { 
          if(fontSize(d[1]/max) > maxfontSize){
            maxfontSize = fontSize(d[1]/max);
          }
          return fontSize(d[1]/max); })
      .text(function(d) { return d[0]; })
      .spiral("archimedean")
      .on("end", draw)
      .start();
  var svg = d3.select('body').append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  var wordcloud = svg.append("g")
      .attr('class','wordcloud')
      .attr("transform", "translate(" + width/2 + "," + height/2 + ")");
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
    .selectAll('text')
      .style('font-size','20px')
      .style('fill',function(d) { return color(d); })
      .style('font','Serif');
  function draw(words) {
    wordcloud.selectAll("text")
        .data(words)
        .enter().append("text")
        .attr('class','word')
        .style("font-size", function(d) { return d.size + "px"; })
        .style("font-family", function(d) { return d.font; })
        .style("fill", color)
        .attr("text-anchor", "middle")
        .attr("transform", function(d) { return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"; })
        .text(function(d) { return d.text; });

  };
}

function checks(genders, locations){

      if (d3.select("#checkFemale").property("checked")){
          genders.push("Female")
      }
      if (d3.select("#checkMale").property("checked")){
          genders.push("Male")
      }
      if (d3.select("#checkAntioquia").property("checked")){
          locations.push("antioquia")
      }
      if (d3.select("#checkBogota").property("checked")){
          locations.push("bogota")
      }
      if (d3.select("#checkCafetero").property("checked")){
          locations.push("cafetero")
      }
      if (d3.select("#checkCaribe").property("checked")){
          locations.push("caribe")
      }
      if (d3.select("#checkCentro").property("checked")){
          locations.push("centro")
      }
      if (d3.select("#checkOriento").property("checked")){
          locations.push("oriento")
      }
      if (d3.select("#checkOtres").property("checked")){
          locations.push("otres")
      }
      if (d3.select("#checkPacifica").property("checked")){
          locations.push("pacifica")
      }
      if (d3.select("#checkOtro").property("checked")){
          locations.push("other")
      }

}

function updateData(){
    var genders = [];
    var locations = [];

      if (d3.select("#checkFemale").property("checked")){
          genders.push("Female")
      }
      if (d3.select("#checkMale").property("checked")){
          genders.push("Male")
      }
      if (d3.select("#checkAntioquia").property("checked")){
          locations.push("Antioquia")
      }
      if (d3.select("#checkBogota").property("checked")){
          locations.push("Bogota")
      }
      if (d3.select("#checkCafetero").property("checked")){
          locations.push("Cafetero")
      }
      if (d3.select("#checkCaribe").property("checked")){
          locations.push("Caribe")
      }
      if (d3.select("#checkCentro").property("checked")){
          locations.push("Centro")
      }
      if (d3.select("#checkOriento").property("checked")){
          locations.push("Oriento")
      }
      if (d3.select("#checkOtres").property("checked")){
          locations.push("Otres")
      }
      if (d3.select("#checkPacifica").property("checked")){
          locations.push("Pacifica")
      }
      if (d3.select("#checkOtro").property("checked")){
          locations.push("-1")
      }

    console.log("updating");

    d3.csv("twitter.csv", function(error, data) {
      console.log(genders);
      console.log(locations);
      var new_hashes = "";
      var newObjs = [];

      data.forEach(function(d){
          //console.log(h);
          if(locations.indexOf(d.user_location) == -1){
            return;
          }
          if(genders.indexOf(d.user_gender) == -1){
            return;
          }

          var h = d.tweet_hashtag;
          h = h.replace(/,/g, " ");

          new_hashes += h;
          new_hashes += " ";
          

      });

      processFilters(new_hashes, newObjs);


      var wordCount = d3.nest()
                          .key(function(d) {return d.hashtag;})
                          .rollup(function(v) {return v.length;})
                          .entries(newObjs);
          wordCount.sort(function(a,b){
          return b.values-a.values;
        });
        console.log(wordCount);
        var tags = [];
        wordCount.forEach(function(d){
          tags.push([d.key, parseInt(d.values)]);
        });

        var max = wordCount[0].values + 1;
        var maxfontSize = 0;
        tags = tags.slice(0,100); // choose top 250 words

        var color = "#5e6472";
        var fontSize = d3.scale.pow().exponent(5).domain([0,1]).range([10,80]);
        var layout = d3.layout.cloud()
            .timeInterval(10)
            .size([width, height])
            .words(tags)
            .rotate(function(d) { return 0; })
            .font('Raleway')
            .fontSize(function(d,i) { 
                if(fontSize(d[1]/max) > maxfontSize){
                  maxfontSize = fontSize(d[1]/max);
                }
                return fontSize(d[1]/max); })
            .text(function(d) { return d[0]; })
            .spiral("archimedean")
            .on("end", draw)
            .start();

        function draw(words) {
            console.log("in draw");
            console.log(words);
            var wordcloud = d3.selectAll('g.wordcloud').selectAll('text')
                .data(words, function(d) { return d; });
                
            var svg = d3.select('body').selectAll('svg')
            .selectAll('text')
            .style('font-size','20px')
            .style('fill',function(d) { return "#5e6472"; })
            .style('font','Serif');

            wordcloud 
                .enter()
                .append("text")
                .attr('class','word')
                .style("font-size", 1)
                .style("font-family", function(d) { return d.font; })
                .style("fill", color)
                .attr("text-anchor", "middle")
                .attr("transform", function(d) { return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"; })
                .text(function(d) { return d.text; })

            wordcloud
                .transition()
                .duration(600)
                .style("font-size", function(d) { return d.size + "px"; })
                .attr("transform", function(d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .style("fill-opacity", 1);


            wordcloud
                .exit()
                .transition()
                .duration(500)
                .style("fill-opacity", 0)
                .attr('font-size', 1)
                .remove();
          }; 
    });



}



</script>
</body>
